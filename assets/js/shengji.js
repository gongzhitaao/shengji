(function t(r,e,i){function n(a,s){if(!e[a]){if(!r[a]){var d=typeof require=="function"&&require;if(!s&&d)return d(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var u=e[a]={exports:{}};r[a][0].call(u.exports,function(t){var e=r[a][1][t];return n(e?e:t)},u,u.exports,t,r,e,i)}return e[a].exports}var o=typeof require=="function"&&require;for(var a=0;a<i.length;a++)n(i[a]);return n})({1:[function(require,module,exports){module.exports=function(t,r){var e=require("./var.js");var i=[{x:750,y:15},{x:0,y:315},{x:750,y:765},{x:1490,y:315}];var n=[[e.Poker["redback"],e.Poker["blackback"],e.Poker["redback"],e.Poker["blackback"]],[e.Poker["ch"],e.Poker["cs"],e.Poker["cd"],e.Poker["cc"]]];var o=["猜猜我是谁","老冀在震家","不知道","刘博已死"];var a=[0,0,0,0];var s={id:-1,name:""};var d=t.selectAll(".avatar").data([{id:0,name:""},{id:1,name:""},{id:2,name:""},{id:3,name:""}],function(t){return t.id}).enter().append("g").attr("class",function(t){return"avatar "+"avt-"+t.id});d.append("rect").attr("class","card-bg").attr("x",function(t){return i[t.id].x+e.bgXOff}).attr("y",function(t){return i[t.id].y+e.bgYOff}).attr("rx",10).attr("ry",10).attr("width",e.bgW).attr("height",e.bgH);d.append("text").attr("class",function(t){return"poker "+n[a[t.id]][t.id].suit}).attr("dy",e.TxtDy).attr("x",function(t){return i[t.id].x}).attr("y",function(t){return i[t.id].y}).text(function(t){return n[a[t.id]][t.id].text});d.append("rect").attr("class","name-bg").attr("x",function(t){return i[t.id].x}).attr("y",function(t){return i[t.id].y+35}).attr("width",e.bgW).attr("height",40);d.append("text").attr("class","name").attr("dy",e.TxtDy).attr("x",function(t){return i[t.id].x+10}).attr("y",function(t){return i[t.id].y+50}).text(function(t){return o[t.id]});var c=d.append("g").attr("class","dealer dealer-off");c.append("circle").attr("class","dealer-bg").attr("cx",function(t){return i[t.id].x+85}).attr("cy",function(t){return i[t.id].y+16}).attr("fill","yellow").attr("r",25);c.append("text").attr("class","dealer-fg").attr("dy",e.TxtDy).attr("x",function(t){return i[t.id].x+65}).attr("y",function(t){return i[t.id].y}).text(e.Icon["dealer"].text);var u={};u.change_dealer=function(r){t.select(".avatar").selectAll(".dealer-on").classed("dealer-on",false);t.select(".avt-"+r+" .dealer").classed("dealer-off",false).classed("dealer-on",true)};u.me=function(t){s.name=t};u.hideme=function(){t.selectAll(".avatar").data([s],function(t){return t.id}).transition().attr("opacity",0).attr("visibility","hidden")};u.showme=function(){t.selectAll(".avatar").data([s],function(t){return t.id}).transition().attr("opacity",1).attr("visibility","visible")};u.flip=function(i){var d=d3.selectAll(".avatar").data(i,function(t){return t.id});d3.transition().duration(100).each(function(){d.transition().attr("opacity","1e-6").each(function(t){a[t.id]=1-a[t.id]})}).transition().each(function(){d.select(".poker").attr("class",function(t){return"poker "+n[a[t.id]][t.id].suit}).text(function(t){return n[a[t.id]][t.id].text});d.select(".name").text(function(t){return t.name?t.name:o[t.id]})}).transition().each(function(){d.transition().attr("opacity","1")});if(s.id>=0)return;d=t.selectAll(".avatar");d.filter(function(t){return a[t.id]}).on("click",null);d.filter(function(t){return!a[t.id]}).on("click",function(i,n){t.selectAll(".avatar").on("click",null);store.session.clear();s.id=i.id;store.session("me",s);r.emit("join",s);u.flip([s]);f();t.append("g").attr("class","btn").on("click",function(){d3.select(this).remove();r.emit("ready")}).append("text").attr("x",800).attr("y",675).attr("text-anchor","middle").attr("dy",e.TxtDy).text("搞起！")})};function f(){if(2==s.id)return;var t=(6-s.id)%4;d3.selectAll(".avatar").transition(1e3).attr("transform",function(r,e){var n=(r.id+t)%4;var o=i[n].x-i[r.id].x;var a=i[n].y-i[r.id].y;return"translate("+o+","+a+")"})}return u}},{"./var.js":5}],2:[function(require,module,exports){module.exports=function(t,r){var e=require("./var.js");var i=t.append("g").attr("class","declarer").attr("visibility","hidden").attr("opacity",0);var n="2";var o={s:"spade",c:"club",h:"heart",d:"diamond",r:"redjoker",b:"blackjoker"};var a={redjoker:["heart","diamond"],blackjoker:["club","spade"]};var s=-1;var d=-1;var c={suit:"",n:0};var u;var f={redjoker:0,blackjoker:0,spade:0,diamond:0,club:0,heart:0};var l={spade:0,club:0,heart:0,diamond:0,blackjoker:1,redjoker:2};var x=true;var g=40;var m=40;var v=25;var p=i.append("text").attr("x",400).attr("y",650).attr("dy",e.TxtDy).attr("visibility","hidden").attr("class","poker btn agree").text(e.Icon["bulb"].text).on("click",function(){r.emit("agreed",s);O.enabled(false)});var k=[];{var h,b,y;var P=["club","heart","spade","diamond"];for(h=0;h<P.length;++h){y=P[h];for(b=1;b<=3;++b)k.push({id:b+y[0],n:b})}var C=["blackjoker","redjoker"];for(h=0;h<C.length;++h){y=C[h];for(b=2;b<=3;++b)k.push({id:b+y[0],n:b})}}var S=i.selectAll("g").data(k,function(t){return t.id}).enter().append("g");S.attr("class","decl-no");S.each(function(t,r){var i=k.length/2;O=d3.select(this);var n=o[t.id.slice(-1)];for(var a=0;a<t.n;++a){var s=(r-i)*g+800,d=v+(2-a)*m+600;O.append("text").attr("x",s).attr("y",d).attr("dy",e.TxtDy).attr("class","poker "+n).text(e.Poker[n+"0"].text)}});function j(){var t=[];var r,e,i,n;if(s==u.id){i=c.suit;for(r=c.n+1;r<=f[i];++r)t.push({id:r+i[0],n:r})}else if(s>=0){if(d<0){for(i in a){if(f[i]){if(f[i]>=c.n){if(f[i]>=2&&l[i]>l[c.suit])t.push({id:c.n+i[0],n:c.n});for(r=c.n+1;r<=f[i];++r)t.push({id:r+i[0],n:r})}for(r=0;r<a[i].length;++r){n=a[i][r];if(f[n]>=c.n){if(l[n]>l[c.suit])t.push({id:c.n+n[0],n:c.n});for(e=c.n+1;e<=f[n];++e)t.push({id:e+n[0],n:e})}}}}}}else{for(i in a){if(f[i]){for(r=2;r<=f[i];++r)t.push({id:r+i[0],n:r});for(r=0;r<a[i].length;++r){n=a[i][r];for(e=1;e<=f[n];++e)t.push({id:e+n[0],n:e})}}}}return t}function w(){var t=!store.session("drawing");var n=j();var a=i.selectAll("g").data(n,function(t){return t.id});if(t&&d==u.id&&store.session("kittied")){r.emit("agreed",s)}else{if(n.length){a.attr("class","decl-ok").on("click",function(t,e){r.emit("declaring",{id:u.id,suit:o[t.id.slice(-1)],n:t.n})}).selectAll("text").text(function(t){return e.Poker[o[t.id.slice(-1)]].text});p.attr("visibility","visible");if(t)A(true)}else{p.attr("visibility","hidden");if(t){if(s!=u.id)r.emit("agreed",s);A(false)}}a.exit().attr("class","decl-no").on("click",null).selectAll("text").text(function(t){return e.Poker[o[t.id.slice(-1)]+"0"].text})}}var O={};O.update=w;O.declared=function(){s=store.session("declarer");c=store.session("domsuit");if(s==u.id){var t=c.suit;if(t in a)f[t]-=c.n;else if("spade"==t||"club"==t)--f["blackjoker"];else--f["redjoker"]}w()};O.newcard=function(t){if(t.slice(0,-1)==n)++f[o[t.slice(-1)]];w()};O.change_dealer=function(){d=store.session("dealer");n=""+store.session("domrank");if(d<0)return;var t,r;r=store.session("mycards")||[];for(t in f)f[t]=0;for(t=0;t<r.length;++t){var e=r[t].val;if(e.slice(0,-1)==n)++f[o[e.slice(-1)]]}w()};function A(t){if(typeof t!="undefined"){x=t;if(x){u=store.session("me");d=store.session("dealer");i.transition().attr("opacity",1).each("end",function(){i.attr("visibility","visible")})}else{p.attr("visibility","hidden");i.transition().attr("opacity",0).each("end",function(){i.attr("visibility","hidden")})}}return x}O.enabled=A;return O}},{"./var.js":5}],3:[function(require,module,exports){module.exports=function(t){var r=t.append("g").attr("class","echo").attr("transform","translate(800, 375)").append("text").attr("text-anchor","middle").attr("opacity",0);var e={};e.info=function(t){r.text(t).attr("class","info").transition().attr("opacity",1).transition().duration(3e3).attr("opacity",0)};e.warning=function(t){r.text(t).attr("class","warning").transition().attr("opacity",1).transition().duration(3e3).attr("opacity",0)};e.error=function(t){r.text(t).attr("class","error").transition().attr("opacity",1).transition().duration(3e3).attr("opacity",0)};return e}},{}],4:[function(require,module,exports){module.exports=function(t,r){var e=require("./var.js");var i=require("./declarer.js")(t,r);var n=t.append("g").attr("class","mycard");var o="2";var a=[];var s;var d=0;var c={1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,j:11,q:12,k:13,a:14,r:-3,b:-2,dr:-1,c:0,d:1,s:2,h:3};function u(t,r){var e=(c[t.val.slice(-1)]+d)%4,i=(c[r.val.slice(-1)]+d)%4,n=t.val.slice(0,-1),a=r.val.slice(0,-1),s=c[n],u=c[a];if(o==n)s=e,e=c.dr;if(o==a)u=i,i=c.dr;return e-i?e-i:s-u}function f(t,r,o){setTimeout(function(t,r,o){if(i.enabled())i.newcard(t[0]);r.push({val:t[0],id:r.length});r.sort(u);var a=Math.floor(r.length/2);var s=n.selectAll("g").data(r,function(t){return t.id});d3.transition().duration(200).each(function(){var t=s.enter().append("g");t.on("click",function(t,r){var e=d3.select(this);if(e.classed("chosen")){e.classed("chosen",false).attr("transform","")}else{e.classed("chosen",true).attr("transform","translate(0, -20)")}});t.attr("opacity","1e-6");t.append("rect").attr("class","card-bg").attr("x",750+e.bgXOff).attr("y",315+e.bgYOff).attr("rx",10).attr("ry",10).attr("width",e.bgW).attr("height",e.bgH);t.append("text").attr("dy",e.TxtDy).attr("class",function(t,r){return"poker "+e.Poker[t.val].suit}).text(function(t){return e.Poker[t.val].text}).attr("x",750).attr("y",315);s.sort(u);t.transition().attr("opacity",1);t.select(".card-bg").transition().attr("x",function(t,r){return(r-a)*e.CardXOff+800+e.bgXOff}).attr("y",765+e.bgYOff);t.select(".poker").transition().attr("x",function(t,r){return(r-a)*e.CardXOff+800}).attr("y",765).attr("opacity","1")}).transition().each(function(){s.select(".card-bg").transition().attr("x",function(t,r){return(r-a)*e.CardXOff+800+e.bgXOff});s.select(".poker").transition().attr("x",function(t,r){return(r-a)*e.CardXOff+800})});var d=t.slice(1);if(d.length)f(d,r,o);else if(o)o()},600,t,r,o)}function l(t){var r=n.selectAll("g").data(t,function(t){return t.id});t.forEach(function(t){a.splice(_.sortedIndex(a,t),1)});d3.transition().duration(200).each(function(){var i=t.length/2;r.select(".card-bg").transition().attr("x",function(t,r){return(r-i)*e.CardXOff+800+e.bgXOff}).attr("y",465+e.bgYOff);r.select(".poker").transition().attr("x",function(t,r){return(r-i)*e.CardXOff+800}).attr("y",465);r.remove()}).transition().each(function(){var t=n.selectAll("g").data(a);var r=a.length/2;t.sort(u);t.select(".card-bg").transition().attr("x",function(t,i){return(i-r)*e.CardXOff+800+e.bgXOff});t.select(".poker").transition().attr("x",function(t,i){return(i-r)*e.CardXOff+800})})}var x={};x.declarer=i;x.draw=function(t){o=""+store.session("domrank");a=[];f(t,a,function(){store.session("drawing",false);i.update();a.sort(u);store.session("mycards",a)})};x.kitty=function(i){f(i,a,function(){var i=t.append("g").attr("class","btn kitty").attr("transform","translate(800,675)").on("click",function(){var t=n.selectAll(".chosen");if(6==t.size()){i.remove();var e=[],o=[];t.each(function(t){e.push(t);o.push(t.val)});l(e);r.emit("re:kitty",o)}}).append("text").attr("dy",e.TxtDy).text("扣牌")})};x.sort=function(t){if("redjoker"==t||"blackjoker"==t)return;d=(4-c[t[0]])%4;if(!store.session("drawing")){a.sort(u);var r=a.length/2;var i=n.selectAll("g").data(a);i.sort(u);i.select(".card-bg").transition().attr("x",function(t,i){return(i-r)*e.CardXOff+800+e.bgXOff});i.select(".poker").transition().attr("x",function(t,i){return(i-r)*e.CardXOff+800})}};return x}},{"./declarer.js":2,"./var.js":5}],5:[function(require,module,exports){var t={bgW:110,bgH:140,bgXOff:1,bgYOff:-10,TxtDy:".71em",CardXOff:30};t.Poker={club:{text:"♣",suit:"club"},spade:{text:"♠",suit:"spade"},heart:{text:"♥",suit:"heart"},diamond:{text:"♦",suit:"diamond"},club0:{text:"♧",suit:"club"},spade0:{text:"♤",suit:"spade"},heart0:{text:"♡",suit:"heart"},diamond0:{text:"♢",suit:"diamond"},redback:{text:String.fromCodePoint(127136),suit:"redback"},blackback:{text:String.fromCodePoint(127136),suit:"blackback"},redjoker:{text:String.fromCodePoint(127183),suit:"redjoker"},blackjoker:{text:String.fromCodePoint(127183),suit:"blackjoker"},redjoker0:{text:String.fromCodePoint(127199),suit:"redjoker"},blackjoker0:{text:String.fromCodePoint(127199),suit:"blackjoker"},ar:{text:String.fromCodePoint(127183),suit:"redjoker"},"2r":{text:String.fromCodePoint(127183),suit:"redjoker"},"3r":{text:String.fromCodePoint(127183),suit:"redjoker"},"4r":{text:String.fromCodePoint(127183),suit:"redjoker"},"5r":{text:String.fromCodePoint(127183),suit:"redjoker"},"6r":{text:String.fromCodePoint(127183),suit:"redjoker"},"7r":{text:String.fromCodePoint(127183),suit:"redjoker"},"8r":{text:String.fromCodePoint(127183),suit:"redjoker"},"9r":{text:String.fromCodePoint(127183),suit:"redjoker"},"10r":{text:String.fromCodePoint(127183),suit:"redjoker"},jr:{text:String.fromCodePoint(127183),suit:"redjoker"},cr:{text:String.fromCodePoint(127183),suit:"redjoker"},qr:{text:String.fromCodePoint(127183),suit:"redjoker"},kr:{text:String.fromCodePoint(127183),suit:"redjoker"},ab:{text:String.fromCodePoint(127183),suit:"blackjoker"},"2b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"3b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"4b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"5b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"6b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"7b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"8b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"9b":{text:String.fromCodePoint(127183),suit:"blackjoker"},"10b":{text:String.fromCodePoint(127183),suit:"blackjoker"},jb:{text:String.fromCodePoint(127183),suit:"blackjoker"},cb:{text:String.fromCodePoint(127183),suit:"blackjoker"},qb:{text:String.fromCodePoint(127183),suit:"blackjoker"},kb:{text:String.fromCodePoint(127183),suit:"blackjoker"},as:{text:String.fromCodePoint(127137),suit:"spade"},"2s":{text:String.fromCodePoint(127138),suit:"spade"},"3s":{text:String.fromCodePoint(127139),suit:"spade"},"4s":{text:String.fromCodePoint(127140),suit:"spade"},"5s":{text:String.fromCodePoint(127141),suit:"spade"},"6s":{text:String.fromCodePoint(127142),suit:"spade"},"7s":{text:String.fromCodePoint(127143),suit:"spade"},"8s":{text:String.fromCodePoint(127144),suit:"spade"},"9s":{text:String.fromCodePoint(127145),suit:"spade"},"10s":{text:String.fromCodePoint(127146),suit:"spade"},js:{text:String.fromCodePoint(127147),suit:"spade"},cs:{text:String.fromCodePoint(127148),suit:"spade"},qs:{text:String.fromCodePoint(127149),suit:"spade"},ks:{text:String.fromCodePoint(127150),suit:"spade"},ah:{text:String.fromCodePoint(127153),suit:"heart"},"2h":{text:String.fromCodePoint(127154),suit:"heart"},"3h":{text:String.fromCodePoint(127155),suit:"heart"},"4h":{text:String.fromCodePoint(127156),suit:"heart"},"5h":{text:String.fromCodePoint(127157),suit:"heart"},"6h":{text:String.fromCodePoint(127158),suit:"heart"},"7h":{text:String.fromCodePoint(127159),suit:"heart"},"8h":{text:String.fromCodePoint(127160),suit:"heart"},"9h":{text:String.fromCodePoint(127161),suit:"heart"},"10h":{text:String.fromCodePoint(127162),suit:"heart"},jh:{text:String.fromCodePoint(127163),suit:"heart"},ch:{text:String.fromCodePoint(127164),suit:"heart"},qh:{text:String.fromCodePoint(127165),suit:"heart"},kh:{text:String.fromCodePoint(127166),suit:"heart"},ad:{text:String.fromCodePoint(127169),suit:"diamond"},"2d":{text:String.fromCodePoint(127170),suit:"diamond"},"3d":{text:String.fromCodePoint(127171),suit:"diamond"},"4d":{text:String.fromCodePoint(127172),suit:"diamond"},"5d":{text:String.fromCodePoint(127173),suit:"diamond"},"6d":{text:String.fromCodePoint(127174),suit:"diamond"},"7d":{text:String.fromCodePoint(127175),suit:"diamond"},"8d":{text:String.fromCodePoint(127176),suit:"diamond"},"9d":{text:String.fromCodePoint(127177),suit:"diamond"},"10d":{text:String.fromCodePoint(127178),suit:"diamond"},jd:{text:String.fromCodePoint(127179),suit:"diamond"},cd:{text:String.fromCodePoint(127180),suit:"diamond"},qd:{text:String.fromCodePoint(127181),suit:"diamond"},kd:{text:String.fromCodePoint(127182),suit:"diamond"},ac:{text:String.fromCodePoint(127185),suit:"club"},"2c":{text:String.fromCodePoint(127186),suit:"club"},"3c":{text:String.fromCodePoint(127187),suit:"club"},"4c":{text:String.fromCodePoint(127188),suit:"club"},"5c":{text:String.fromCodePoint(127189),suit:"club"},"6c":{text:String.fromCodePoint(127190),suit:"club"},"7c":{text:String.fromCodePoint(127191),suit:"club"},"8c":{text:String.fromCodePoint(127192),suit:"club"},"9c":{text:String.fromCodePoint(127193),suit:"club"},"10c":{text:String.fromCodePoint(127194),suit:"club"},jc:{text:String.fromCodePoint(127195),suit:"club"},cc:{text:String.fromCodePoint(127196),suit:"club"},qc:{text:String.fromCodePoint(127197),suit:"club"},kc:{text:String.fromCodePoint(127198),suit:"club"}};t.Icon={no:{text:String.fromCodePoint(127521)},win:{text:String.fromCodePoint(127559)},lost:{text:String.fromCodePoint(127560)},blackout:{text:String.fromCodePoint(128498)},dealer:{text:String.fromCodePoint(128114)},bulb:{text:String.fromCodePoint(128161)}};module.exports=t},{}],6:[function(require,module,exports){module.exports=function(t){var r=16/9;var e=jQuery(window);var i=d3.select("body").insert("svg").attr("preserveAspectRatio","xMinYMin meet");i.selectAll("line").data([150,300,450,600,750]).enter().append("line").style("stroke","gray").attr("x1",0).attr("y1",function(t){return t}).attr("x2",1600).attr("y2",function(t){return t});function n(){var t,n;var o=e.width()/e.height();if(o>r){t=e.height()-10;n=Math.floor(t*r)}else{n=e.width()-10;t=Math.floor(n/r)}i.style("width",n+"px").style("height",t+"px").style("top",(e.height()-t)/2+"px").style("left",(e.width()-n)/2+"px").attr("viewBox","0, 0, 1600, 900")}n();e.resize(n);var o=require("./mycard.js")(i,t);return{avatar:require("./avatar.js")(i,t),mycard:o,declarer:o.declarer,echo:require("./echo.js")(i)}}},{"./avatar.js":1,"./echo.js":3,"./mycard.js":4}],7:[function(require,module,exports){(function(t,r){"use strict";var e=io.connect("http://localhost:8080/");t(document).ready(function(){var r=require("./widgets/widget.js")(e);t(".overlay button").click(function(r){var i=t(".overlay input");var n=t.trim(i.val());if(!n.length){var o=i.popover({content:"无名少姓之辈！",placement:"top"}).popover("show");setTimeout(function(){o.popover("destroy")},2500)}else{e.emit("login",n)}});e.on("hello",function(t){r.avatar.flip(t);r.echo.info("server says hello")});e.on("re:login",function(e){if(e){r.avatar.me(e);t(".overlay").remove()}else{var i=t(".overlay input");var n=i.popover({content:"此名号已报，请大侠行更名，坐改姓！",placement:"top"}).popover("show");setTimeout(function(){n.popover("destroy")},2500)}});e.on("new player",function(t){r.avatar.flip([t]);r.echo.info("User "+t.name+" logged in.")});e.on("user left",function(t){r.avatar.flip([t])});e.on("dealer",function(t){store.session("dealer",t.id);store.session("domrank",t.domrank);r.avatar.change_dealer(t.id);r.declarer.change_dealer()});e.on("draw",function(t){store.session("drawing",true);store.session("domsuit",{suit:"",n:0});r.avatar.hideme();r.declarer.enabled(true);r.mycard.draw(t)});e.on("declared",function(t){store.session("declarer",t.id);store.session("domsuit",{suit:t.suit,n:t.n});r.mycard.sort(t.suit);r.declarer.declared()});e.on("kitty",function(t){var e=store.session("me");var i=store.session("dealer");if(e.id==i)r.declarer.enabled(false);r.mycard.kitty(t)});e.on("kittying",function(){r.declarer.enabled(false)});e.on("kittied",function(){store.session("kittied",true);r.declarer.update()});e.on("play",function(){console.log("I'm playing")});e.on("disconnect",function(){store.session("drawing",false);store.session("declarer",-1);store.session("domsuit",{suit:"",n:0})})})})(jQuery)},{"./widgets/widget.js":6}]},{},[7]);
